{% extends 'partials/main.html.twig' %}

{% block stylesheets %}

{{ parent() }}

<!-- jsvectormap css -->
<link href="{{ asset('libs/jsvectormap/css/jsvectormap.min.css') }}" rel="stylesheet" type="text/css" />

<!--Swiper slider css-->
<link href="{{ asset('libs/swiper/swiper-bundle.min.css') }}" rel="stylesheet" type="text/css" />

{% endblock %}

{% block content %}

<div class="container-fluid">
    {% if s10CodeGenerated is defined and s10CodeGenerated is not null%}
    <div class="row">
        <div class="col-xs-12 text-center">
            <h1 class="alert alert-success">
                <img src="{{ asset(s10CodeGenerated.barcodeImage) }}" alt="CÃ³digo de Barras S10">
                <br>
                {{ s10CodeGenerated.getFormattedNumbercode }}
            </h1>
            <a target="_blank" class="btn btn-primary" href="{{ path('app_pdf_cn22', { 's10code_id':s10CodeGenerated.id}) }}">Ver
                CN22</a>
                <a target="_blank" class="btn btn-primary" href="{{ path('app_pdf_cn23', { 's10code_id':s10CodeGenerated.id}) }}">Ver
                    CN23</a>
        </div>
    </div>
    {% endif %}

    {{form_start(form)}}
    <div class="row">
        <div class="col-xl-4">
            {{ form_label (form.postalProduct) }}
            {{ form_widget (form.postalProduct) }}
            {{ form_errors (form.postalProduct)}}
        </div>
        <div class="col-xl-4">
            {{ form_label (form.postalService) }}
            {{ form_widget (form.postalService) }}
            {{ form_errors (form.postalService)}}
        </div>
        <div class="col-xl-4">
            {{ form_label (form.toCountry) }}
            {{ form_widget (form.toCountry) }}
            {{ form_errors (form.toCountry)}}
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-12 d-grid gap-2">
            {{ form_widget (form.submit) }}
        </div>
    </div>
    {{form_end(form)}}

    <div class="row mt-5">
        <div class="col-xs-12">
            <table id="s10table" class="table">
                <thead>
                    <tr>
                        <th>
                            Id
                        </th>
                        <th>
                            Producto
                        </th>
                        <th>
                            Servicio
                        </th>
                        <th>
                            Pais destino
                        </th>
                        <th>
                            Codigo S10
                        </th>
                        <th>
                            Formularios aduana
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for s10 in s10codes %}

                    <tr>
                        <td>
                            {{s10.id}}
                        </td>
                        <td>
                            {{s10.postalServiceRange.postalService.postalProduct.name}}
                        </td>
                        <td>
                            {{s10.postalServiceRange.postalService.name}}
                        </td>
                        <td>
                            {{s10.toCountry.name}}
                        </td>
                        <td>
                            {{s10.getFormattedNumbercode}}
                        </td>
                        <td class="text-center">
                            <a target="_blank" href="{{ path('app_pdf_cn22', { 's10code_id':s10.id}) }}" class="btn btn-primary">Ver CN22</a>
                            <a target="_blank" href="{{ path('app_pdf_cn23', { 's10code_id':s10.id}) }}" class="btn btn-primary">Ver CN23</a>
                        </td>
                    </tr>

                    {% endfor %}

                </tbody>
            </table>
        </div>

    </div>
</div>


{% endblock %}

{% block javascripts %}

{{ parent() }}

<script>
    $(document).ready(() => {
        listenPostalProduct()
        initDataTable();
    })

    const initDataTable = () => {
        let table = new DataTable('#s10table', {
            language: {
                url: '//cdn.datatables.net/plug-ins/2.1.5/i18n/es-MX.json',
            },
        });
    }

    const listenPostalProduct = () => {
        let id = $('#s10_code_postalProduct').val();
        if (id) {
            getTipoDeServicio(id);
        }
        $('#s10_code_postalProduct').on('change', function () {
            id = $(this).val();
            getTipoDeServicio(id);
        });
    }


    const getTipoDeServicio = (id) => {
        $.ajax({
            url: '{{ path("app_secure_postal_service") }}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ id: parseInt(id) }),
            success: async (res) => {
                if (res.success) {
                    postalServices = await res.data;
                    cleanSelects();
                    $("#s10_code_postalService").prop("disabled", false);
                    for (let i = 0; i < postalServices.length; i++) {
                        const element = postalServices[i];
                        const option = $("<option></option>").text(element.name);
                        option.attr("value", element.id);
                        $("#s10_code_postalService").append(option);
                    }
                } else {
                    cleanSelects(true);
                }
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
            }
        });
    }

    const cleanSelects = (disable = false) => {
        const defaultOptionSelect = $("<option></option>").text(
            "Seleccione un tipo de servicio"
        );
        $("#s10_code_postalService").html(defaultOptionSelect);
        if (disable) {
            $("#s10_code_postalService").prop("disabled", true);
        }
    };


</script>

{% endblock %}